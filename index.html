<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Heures suppl√©mentaires ‚Äì Paie mensuelle</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* =======================
   TOP BAR
======================= */
.topbar{
  position: sticky;
  top: 0;
  z-index: 2000;
  background: var(--bg);
  padding: calc(env(safe-area-inset-top) + 10px) 15px 10px;
}

/* =======================
   MODE SOMBRE ‚Äì GLOBAL
======================= */
:root{
  --bg:#0f1115;
  --card:#1c1f26;
  --text:#e6e6e6;
  --muted:#9aa0a6;
  --accent:#4f8cff;
  --danger:#c0392b;
  --success:#2ecc71;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;
}

.main{
  padding:15px;
}
h1,h2,h3{text-align:center}
button{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  background:var(--accent);
  color:white;
  font-size:15px;
  margin-top:6px;
}
button.secondary{background:#2a2f3a}
button.danger{background:var(--danger)}
input,select{
  width:100%;
  padding:8px;
  margin-top:6px;
  background:#262a33;
  color:var(--text);
  border:1px solid #333;
  border-radius:6px;
}

/* =======================
   CARTES
======================= */
.card{
  background:var(--card);
  padding:15px;
  border-radius:12px;
  margin-top:15px;
}

/* =======================
   CALENDRIER
======================= */
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}
.weekday{
  text-align:center;
  font-weight:bold;
  font-size:12px;
}
.day{
  background:#262a33;
  border-radius:8px;
  padding:6px;
  text-align:center;
  cursor:pointer;
  min-height:60px;
}
.day.today{
  border:2px solid #ff9500;
}
.day.locked{
  opacity:.4;
  cursor:not-allowed;
}

/* =======================
   MODALES
======================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:4000;
}
.modal-content{
  background:var(--card);
  padding:20px;
  border-radius:12px;
  width:90%;
  max-width:420px;
}
#hoursChoices button{
  background:#2a2f3a;
}

/* =======================
   FLOU ‚Ç¨
======================= */
.blur{
  filter:blur(8px);
}

/* =======================
   BADGES
======================= */
.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:12px;
  font-size:12px;
}
.badge.ok{background:#1b5e20}
.badge.file{background:#283593}
input[type="month"]{
  text-align: center;
  padding-right: 0;
  appearance: none;
  -webkit-appearance: none;
}
input[type="number"]{
  text-align: center;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: textfield;
  padding-left: 0;
  padding-right: 0;
}
.day.after-closing{
  border: 1px dashed #4f8cff;
  opacity: 0.75;
}
.day{
  transition: 
    border 0.2s ease,
    opacity 0.2s ease,
    transform 0.1s ease;
}
.day.today{
  border:2px solid #ff9500 !important;
  opacity: 1 !important;
  background: #2e2a1f;
  box-shadow: 0 0 0 2px rgba(255,149,0,0.4);
  transform: scale(1.03);
  z-index: 2;
}
.day.after-closing.today{
  opacity: 1 !important;
  border-style: solid;
}
</style>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<div class="topbar">
  <button onclick="openTutorial()">‚ùì Tutoriel</button>
</div>

<div class="main">

  <h1>‚è±Ô∏è Heures suppl√©mentaires</h1>

  <div class="card">
    <label>Mois suivi</label>
    <input type="month" id="monthPicker">
    <label>Jour de cl√¥ture mensuelle</label>
 <input type="date" id="closingDate">
  </div>

  <div class="calendar card" id="calendar"></div>
  
<div class="card">
  <h3>R√©capitulatif</h3>
  <p>Report pr√©c√©dent : <b id="prevCarry">0.00</b> h</p>
<p>Total mois : <b id="totalMonth">0.00</b> h</p>
<p>Heures √† 25 % : <b id="hours25">0.00</b> h</p>
<p>Heures √† 50 % : <b id="hours50">0.00</b> h</p>
  <p>Heures pay√©es : <input type="number" id="paidHours" step="0.25"></p>
  <p>Reliquat report√© : <b id="carryOver">0.00</b> h</p>

  <button id="lockBtn">üîì Mois modifiable</button>
</div>

<div class="card">
  <h3>üí∞ Valeur ‚Ç¨</h3>
  <div id="euroBox" class="blur">
    <label>Taux horaire (‚Ç¨)</label>
    <input type="number" id="rate">
    <label>Coef 25 %</label>
    <input type="number" id="coef25">
    <label>Coef 50 %</label>
    <input type="number" id="coef50">
    <label>Coef brut ‚Üí net</label>
    <input type="number" id="coefNet">
    <p><b id="euroResult">0.00 ‚Ç¨</b></p>
    <p id="euroDetail" style="font-size:12px;color:#aaa;margin-top:8px"></p>
  </div>
  <input type="password" id="unlockCode" placeholder="Code (1234)">
  <button onclick="unlockEuro()">D√©verrouiller</button>
</div>
<button class="secondary" onclick="toggleChangeCode()">üîÅ Changer le code</button>

<div id="changeCodeBox" style="display:none;margin-top:10px">
  <input type="password" id="oldCode" placeholder="Ancien code">
  <input type="password" id="newCode" placeholder="Nouveau code (4 chiffres min)">
  <input type="password" id="confirmCode" placeholder="Confirmer le code">
  <button class="danger" onclick="changeCode()">Valider le nouveau code</button>
</div>
<div class="card">
  <span class="badge ok">üü¢ Sauvegarde locale auto</span>
  <span class="badge file">üíæ Dernier fichier : <span id="fileDate">‚Äî</span></span>
  <button onclick="exportJSON()">üíæ Sauvegarde dans un fichier</button>
  <input type="file" id="importFile" accept=".json" style="display:none">
<button class="secondary" onclick="document.getElementById('importFile').click()">
üì• Importer une sauvegarde
</button>
   <button onclick="exportMonthlyPDF()">üìÑ PDF mensuel d√©taill√©</button>
<button onclick="exportAnnualPDF()">üìï PDF annuel r√©capitulatif</button>
</div>

<!-- =======================
     POPUP HEURES
======================= -->
<div class="modal" id="hoursModal">
  <div class="modal-content">
    <h3>‚è±Ô∏è Ajouter des heures</h3>
    <div id="hoursChoices"></div>
    <label>Saisie manuelle</label>
    <input type="number" id="manualHours" step="0.25">
    <button onclick="confirmManual()">Valider</button>
    <button class="danger" onclick="deleteDayHours()">üóëÔ∏è Supprimer les heures du jour</button>
    <button class="secondary" onclick="closeHours()">Annuler</button>
  </div>
</div>
<div class="modal" id="tutorialModal">
  <div class="modal-content" style="max-width:700px;max-height:80vh;overflow:auto;">
    <h2>üìò Tutoriel ‚Äì Suivi des heures suppl√©mentaires</h2>

    <h3>1Ô∏è‚É£ Principe g√©n√©ral</h3>
    <p>
      Cet outil permet de suivre les heures suppl√©mentaires dans le cadre
      d‚Äôune <b>paie mensuelle</b>, avec report automatique des reliquats.
    </p>

    <h3>2Ô∏è‚É£ Saisie des heures</h3>
    <ul>
      <li>Clique sur un jour</li>
      <li>Choisis +15 min, +30 min, +1h‚Ä¶ ou saisis manuellement</li>
      <li>Les heures sont enregistr√©es automatiquement</li>
    </ul>

    <h3>3Ô∏è‚É£ Cl√¥ture mensuelle</h3>
    <p>
      Le jour de cl√¥ture d√©finit la fin de la p√©riode de paie.
      Les heures apr√®s cette date sont automatiquement report√©es.
    </p>

    <h3>4Ô∏è‚É£ Zone ‚Ç¨</h3>
    <p>
      Les montants sont flout√©s par d√©faut et prot√©g√©s par code.
    </p>

    <button class="secondary" onclick="closeTutorial()">Fermer</button>
  </div>
</div>

<script>

/* =======================
   DONN√âES
======================= */
const STORAGE_PREFIX = "CA_HS_TRACKER_V1";
function kData(year){
  return `${STORAGE_PREFIX}_DATA_${year}`;
}
function kSettings(){
  return `${STORAGE_PREFIX}_SETTINGS`;
}
function kCode(){
  return `${STORAGE_PREFIX}_CODE_HASH`;
}
function kIndex(){
  return `${STORAGE_PREFIX}_INDEX`;
}
function kBackup(year, date){
  return `${STORAGE_PREFIX}_BACKUP_${year}_${date}`;
}
function getYearFromMonth(key){
  return key.split("-")[0];
}
let DATA = {};
let SETTINGS = JSON.parse(
  localStorage.getItem(kSettings()) || "{}"
);
let currentKey="", currentDay=null, unlocked=false;
const closingDate = document.getElementById("closingDate");
/* =======================
   INIT
======================= */
const monthPicker = document.getElementById("monthPicker");
monthPicker.value = new Date().toISOString().slice(0,7);
const paidInput = document.getElementById("paidHours");
paidInput.oninput = () => {
  DATA[currentKey].paid = parseFloat(paidInput.value) || 0;
  save();
  recalc();
};
monthPicker.onchange = loadMonth;
/* =======================
   CALENDRIER
======================= */

function loadMonth(){
  currentKey = monthPicker.value;
  const year = getYearFromMonth(currentKey);

  registerYear(year);
  DATA = loadYearData(year);

  if(!DATA[currentKey]){
    DATA[currentKey] = {
      days: {},
      paid: 0,
      carry: 0,
      closing: 31,
      locked: false
    };
  }

  paidInput.value = DATA[currentKey].paid || 0;

  setClosingLimits();
  syncClosingDate();

  renderCalendar();
  recalc();
  updateLockUI();
  scrollToToday();
}




function syncClosingDate(){
  if(!DATA[currentKey]) return;

  const [y, m] = currentKey.split("-").map(Number);
  const day = DATA[currentKey].closing || 31;

  closingDate.value =
    `${y}-${String(m).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
}

function setClosingLimits(){
  const [y, m] = currentKey.split("-").map(Number);
  const lastDay = new Date(y, m, 0).getDate();

  closingDate.min = `${y}-${String(m).padStart(2,"0")}-01`;
  closingDate.max = `${y}-${String(m).padStart(2,"0")}-${lastDay}`;
}

closingDate.oninput = () => {
  if(!closingDate.value) return;

  const selected = new Date(closingDate.value);
  const [y, m] = currentKey.split("-").map(Number);

  if(
    selected.getFullYear() !== y ||
    selected.getMonth() + 1 !== m
  ){
    alert("‚õî La date doit √™tre dans le mois s√©lectionn√©");
    syncClosingDate();
    return;
  }

  DATA[currentKey].closing = selected.getDate();
  save();
  renderCalendar();
  recalc();
};
function scrollToToday(){
  const today = new Date().toISOString().slice(0,7);
  if(currentKey !== today) return;

  const todayEl = document.getElementById("todayCell");
  if(todayEl){
    todayEl.scrollIntoView({
      behavior: "smooth",
      block: "center"
    });
  }
}
function renderCalendar(){
  const cal = document.getElementById("calendar");
  cal.innerHTML = "";

  // üóìÔ∏è Jours de la semaine
  const weekDays = ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];
  weekDays.forEach(d=>{
    const w = document.createElement("div");
    w.className = "weekday";
    w.textContent = d;
    cal.appendChild(w);
  });

  const [y, m] = currentKey.split("-").map(Number);
  const today = new Date();
const isCurrentMonth = currentKey === today.toISOString().slice(0,7);
  const firstDay = new Date(y, m-1, 1).getDay() || 7; // lundi = 1
  const daysInMonth = new Date(y, m, 0).getDate();
  const closing = DATA[currentKey].closing;
  const isMonthLocked = DATA[currentKey].locked;

  // ‚¨ÖÔ∏è D√©calage du 1er jour du mois
  for(let i=1;i<firstDay;i++){
    cal.appendChild(document.createElement("div"));
  }

  for(let d = 1; d <= daysInMonth; d++){
    const div = document.createElement("div");
    div.className = "day";

    const isAfterClosing = d > closing;

    /* ====== √âtat visuel ====== */

    if(isAfterClosing){
      div.classList.add("after-closing"); // heures report√©es
    }

    if(isMonthLocked){
      div.classList.add("locked"); // verrouillage total
    }

    if(
      isCurrentMonth &&
      d === today.getDate()
    ){
      div.classList.add("today");
    }
if(isCurrentMonth && d === today.getDate()){
  div.id = "todayCell";
}
    /* ====== Contenu ====== */

    const val = DATA[currentKey].days[d];
    div.innerHTML = `
      <b>${d}</b><br>
      ${val ? val.toFixed(2) + " h" : ""}
    `;

    /* ====== Interaction ====== */

    if(!isMonthLocked){
      div.onclick = () => openHours(d);
    }

    cal.appendChild(div);
  }
}
/* =======================
   POPUP HEURES
======================= */
function deleteDayHours(){
  if(DATA[currentKey].locked){
    alert("üîí Mois verrouill√©");
    return;
  }

  if(!currentDay || !DATA[currentKey].days[currentDay]){
    alert("‚ÑπÔ∏è Aucune heure √† supprimer");
    return;
  }

  if(!confirm(`Supprimer toutes les heures du ${currentDay} ?`)) return;

  // üóëÔ∏è suppression r√©elle
  delete DATA[currentKey].days[currentDay];

  currentDay = null; // ‚úÖ reset √©tat

  save();            // recalcul cascade + sauvegarde
  renderCalendar();  // ‚úÖ MAJEUR : refresh UI
  recalc();          // ‚úÖ recalcul live
  closeHours();
}
function openHours(d){
  currentDay=d;
  const c=document.getElementById("hoursChoices");
  c.innerHTML="";
  [0.25,0.5,0.75,1,1.25,1.5,2].forEach(v=>{
    const b=document.createElement("button");
    b.textContent="+"+v+" h";
    b.onclick=()=>applyHours(v);
    c.appendChild(b);
  });
  document.getElementById("hoursModal").style.display="flex";
}
function closeHours(){
  document.getElementById("hoursModal").style.display="none";
}
function applyHours(h){
  if(h <= 0) return;

  DATA[currentKey].days[currentDay] =
    (DATA[currentKey].days[currentDay] || 0) + h;

  save();
  renderCalendar(); // ‚úÖ AJOUT
  recalc();
  closeHours();
}
function confirmManual(){
  const input = document.getElementById("manualHours");
  const h = parseFloat(input.value);
 if(isNaN(h) || h <= 0){
  alert("‚õî Valeur invalide");
  return;
}

  applyHours(h);
  input.value = ""; // ‚úÖ reset
}
/* =======================
   CALCUL
======================= */
function recalc(){
  const close = DATA[currentKey].closing || 31;

  let inPeriod = 0;
  let outPeriod = 0;

  Object.entries(DATA[currentKey].days).forEach(([d,h])=>{
    if(parseInt(d) <= close) inPeriod += h;
    else outPeriod += h;
  });

  const year = getYearFromMonth(currentKey);
const months = Object.keys(DATA)
  .filter(k => k.startsWith(year))
  .sort();

const idx = months.indexOf(currentKey);
const prevCarry = idx > 0 ? DATA[months[idx - 1]].carry : 0;
  const paid = parseFloat(DATA[currentKey].paid) || 0;

  document.getElementById("prevCarry").textContent = prevCarry.toFixed(2);
  const totalWithCarry = inPeriod + prevCarry;
document.getElementById("totalMonth").textContent =
  totalWithCarry.toFixed(2);
  const payable = Math.max(0, inPeriod + prevCarry - paid);
  document.getElementById("carryOver").textContent =
  payable.toFixed(2);

  
  const h25 = Math.min(8, payable);
  const h50 = Math.max(0, payable - 8);

  document.getElementById("hours25").textContent = h25.toFixed(2);
  document.getElementById("hours50").textContent = h50.toFixed(2);

  if(unlocked){
  calcEuro();
}
}
/* =======================
   ‚Ç¨ CALCUL
======================= */
function calcEuro(){
  if(!unlocked) return;

  const rate = Number(document.getElementById("rate").value) || 0;
  const coef25 = Number(document.getElementById("coef25").value) || 1.25;
  const coef50 = Number(document.getElementById("coef50").value) || 1.50;
  const netCoef = Number(document.getElementById("coefNet").value) || 1;

  const h25 = Number(document.getElementById("hours25").textContent) || 0;
  const h50 = Number(document.getElementById("hours50").textContent) || 0;

  const weighted25 = h25 * coef25;
  const weighted50 = h50 * coef50;
  const weightedTotal = weighted25 + weighted50;

  const brut = weightedTotal * rate;
  const net = brut * netCoef;

  document.getElementById("euroResult").textContent =
    net.toFixed(2) + " ‚Ç¨";

  document.getElementById("euroDetail").innerHTML = `
    ${h25.toFixed(2)} h √ó ${coef25} = ${weighted25.toFixed(2)} h<br>
    ${h50.toFixed(2)} h √ó ${coef50} = ${weighted50.toFixed(2)} h<br>
    <b>Total pond√©r√© : ${weightedTotal.toFixed(2)} h</b><br>
    ${weightedTotal.toFixed(2)} √ó ${rate} ‚Ç¨ √ó ${netCoef}
  `;
}
async function sha256(str){
  const buf = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest("SHA-256", buf);
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2,"0"))
    .join("");
}

async function getSecureCode(){
  let h = localStorage.getItem(kCode());
  if(!h){
    h = await sha256("1234");
    localStorage.setItem(kCode(), h);
  }
  return h;
}
async function unlockEuro(){
  const input = document.getElementById("unlockCode").value;
  const inputHash = await sha256(input);

  if(inputHash === await getSecureCode()){
    unlocked = true;
    document.getElementById("euroBox").classList.remove("blur");
    document.getElementById("unlockCode").value = "";
    recalc();

    if(input === "1234"){
      alert("‚ö†Ô∏è Pense √† changer le code par d√©faut");
    }

  } else {
    alert("‚ùå Code incorrect");
  }
}
function toggleChangeCode(){
  if(!unlocked){
    alert("üîí D√©verrouille d‚Äôabord la zone ‚Ç¨");
    return;
  }
  const box = document.getElementById("changeCodeBox");
  box.style.display = box.style.display === "none" ? "block" : "none";
}



/* =======================
   SAUVEGARDE
======================= */
function save(){
  const year = getYearFromMonth(currentKey);
  recalcCascade(currentKey); // ‚úÖ recalcul global
  saveYearData(year, DATA);
  autoBackup(year);
}
async function changeCode(){
  const oldC = document.getElementById("oldCode").value;
  const newC = document.getElementById("newCode").value;
  const confC = document.getElementById("confirmCode").value;

  if(await sha256(oldC) !== await getSecureCode()){
    alert("‚ùå Ancien code incorrect");
    return;
  }

  if(newC.length < 4){
    alert("‚ö†Ô∏è 4 caract√®res minimum");
    return;
  }

  if(newC !== confC){
    alert("‚ùå Confirmation diff√©rente");
    return;
  }

  localStorage.setItem(kCode(), await sha256(newC));
  alert("‚úÖ Code modifi√©");

  document.getElementById("changeCodeBox").style.display="none";
}

lockBtn.onclick = ()=>{
  DATA[currentKey].locked = !DATA[currentKey].locked;
  save();
  updateLockUI();
};
function exportJSON(){
  const year = getYearFromMonth(currentKey);

const payload = {
  exportedAt: new Date().toISOString(),
  year,
  version: "1.2",
  DATA,
  SETTINGS
};

  const blob = new Blob(
    [JSON.stringify(payload,null,2)],
    {type:"application/json"}
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "heures_sup_backup_"+Date.now()+".json";
  a.click();

  document.getElementById("fileDate").textContent =
    new Date().toLocaleDateString();
}
function updateLockUI(){
  lockBtn.textContent = DATA[currentKey].locked
    ? "üîí Mois verrouill√©"
    : "üîì Mois modifiable";
}
/* =======================
   PARAMS ‚Ç¨
======================= */
["rate","coef25","coef50","coefNet"].forEach(id=>{
  let def;
  if(id === "rate") def = 20;
  else if(id === "coef25") def = 1.25;
  else if(id === "coef50") def = 1.50;
  else if(id === "coefNet") def = 0.93;

  const input = document.getElementById(id);
  input.value = SETTINGS[id] ?? def;

  input.oninput = () => {
    SETTINGS[id] = parseFloat(input.value) || 0;
    localStorage.setItem(
      kSettings(),
      JSON.stringify(SETTINGS)
    );
    recalc();
  };
});
   function openTutorial(){
  document.getElementById("tutorialModal").style.display = "flex";
}
function closeTutorial(){
  document.getElementById("tutorialModal").style.display = "none";
}
function exportMonthlyPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.text("R√©capitulatif mensuel ‚Äì Heures suppl√©mentaires",10,15);
  pdf.text("Mois : "+currentKey,10,25);
  const total = document.getElementById("totalMonth").textContent;
pdf.text("Total p√©riode : "+total+" h",10,35);
  pdf.text("Report : "+carryOver.textContent+" h",10,45);
  pdf.save("heures_mensuelles_"+currentKey+".pdf");
}

function exportAnnualPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y=15;
  pdf.text("Bilan annuel ‚Äì Heures suppl√©mentaires",10,y); y+=10;

  Object.keys(DATA).sort().forEach(k=>{
    pdf.text(k+" ‚Üí "+(DATA[k].carry||0)+" h",10,y);
    y+=6;
    if(y>270){pdf.addPage();y=15;}
  });

  pdf.save("heures_annuelles.pdf");
}

loadMonth();

function autoBackup(year){
  const stamp = new Date().toISOString().slice(0,10);
  const key = kBackup(year, stamp);

  localStorage.setItem(
    key,
    JSON.stringify({DATA, SETTINGS})
  );

  // üßπ Nettoyage : max 30 backups par ann√©e
  const keys = Object.keys(localStorage)
    .filter(k => k.startsWith(`${STORAGE_PREFIX}_BACKUP_${year}_`))
    .sort(); // ordre chrono

  if(keys.length > 30){
    keys.slice(0, keys.length - 30).forEach(k =>
      localStorage.removeItem(k)
    );
  }
}
function registerYear(year){
  let index = JSON.parse(localStorage.getItem(kIndex()) || "[]");
  if(!index.includes(year)){
    index.push(year);
    index.sort();
    localStorage.setItem(kIndex(), JSON.stringify(index));
  }
}

function loadYearData(year){
  return JSON.parse(
    localStorage.getItem(kData(year)) || "{}"
  );
}

function saveYearData(year, data){
  localStorage.setItem(
    kData(year),
    JSON.stringify(data)
  );
}
function recalcCascade(){
  const years = Object.keys(DATA)
    .map(k => k.slice(0,4))
    .filter((v,i,a) => a.indexOf(v) === i)
    .sort();

  years.forEach(year => {
    const months = Object.keys(DATA)
      .filter(k => k.startsWith(year))
      .sort(); // YYYY-MM

    // Reset propre
    months.forEach(k => DATA[k].carry = 0);

    for(let i = 0; i < months.length; i++){
      const key = months[i];
      const month = DATA[key];
      const prevMonth = i > 0 ? DATA[months[i - 1]] : null;

      const prevCarry = prevMonth ? prevMonth.carry : 0;

      let inPeriod = 0;
      let outPeriod = 0;

      Object.entries(month.days || {}).forEach(([d,h])=>{
        if(parseInt(d) <= month.closing) inPeriod += h;
        else outPeriod += h;
      });

      const paid = parseFloat(month.paid) || 0;

      // Heures r√©ellement dues √† la fin de la p√©riode
      const due = Math.max(0, prevCarry + inPeriod - paid);

      // Reliquat du mois
      month.carry = due;

      // üî• REPORT R√âEL vers le mois suivant
      if(months[i + 1]){
        DATA[months[i + 1]].carry =
          (DATA[months[i + 1]].carry || 0) + outPeriod;
      }
    }
  });
}
function importJSONFile(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();

  reader.onload = () => {
    let payload;

    try{
      payload = JSON.parse(reader.result);
    } catch(err){
      alert("‚ùå Fichier invalide");
      return;
    }

    // üîí V√©rifications minimales
    if(!payload.DATA || !payload.year){
      alert("‚ùå Format non reconnu");
      return;
    }

    const year = payload.year;// ‚úÖ Appliquer les param√®tres ‚Ç¨
if(payload.SETTINGS){
  SETTINGS = payload.SETTINGS;
  localStorage.setItem(
    kSettings(),
    JSON.stringify(SETTINGS)
  );
}
    registerYear(year);

    const existing = loadYearData(year);

    let added = 0;
    let skipped = 0;

    Object.keys(payload.DATA).forEach(monthKey=>{
      if(!existing[monthKey]){
        existing[monthKey] = payload.DATA[monthKey];
        added++;
      } else {
        skipped++;
      }
    });

    saveYearData(year, existing);

    alert(
      `‚úÖ Import termin√©\n\n` +
      `Ann√©e : ${year}\n` +
      `Mois ajout√©s : ${added}\n` +
      `Mois ignor√©s : ${skipped}`
    );

    // Recharge si on est sur la m√™me ann√©e
    if(getYearFromMonth(currentKey) === String(year)){
      DATA = loadYearData(year);
      loadMonth();
    }
  };

  reader.readAsText(file);
  e.target.value = ""; // reset input
}
document.getElementById("importFile").addEventListener("change", importJSONFile);
</script>
<div class="card" style="font-size:13px;color:#aaa">
  <h3>üìò Notice utilisateur</h3>

  <p>
    Cet outil est destin√© au suivi personnel des heures suppl√©mentaires
    dans le cadre d‚Äôune r√©mun√©ration mensuelle.
  </p>

  <p>
    Les calculs sont indicatifs et reposent sur les principes g√©n√©raux :
  </p>

  <ul>
    <li>Code du travail</li>
    <li>Convention collective du commerce de gros (IDCC 573)</li>
  </ul>

  <p>
    ‚ö†Ô∏è En cas de litige, seuls les bulletins de paie et documents
    officiels de l‚Äôemployeur font foi.
  </p>
</div>
<footer style="margin-top:30px;text-align:center;font-size:12px;color:#777">
  ¬© Tous droits r√©serv√©s ‚Äì C. Anthony<br>
  Outil indicatif ‚Äì ne constitue pas un bulletin de paie
</footer>

</body>
</html>
