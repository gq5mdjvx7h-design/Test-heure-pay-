<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Heures suppl√©mentaires ‚Äì Paie mensuelle</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* =======================
   MODE SOMBRE ‚Äì GLOBAL
======================= */
:root{
  --bg:#0f1115;
  --card:#1c1f26;
  --text:#e6e6e6;
  --muted:#9aa0a6;
  --accent:#4f8cff;
  --danger:#c0392b;
  --success:#2ecc71;
}
body{
  margin:0;
  padding:15px;
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;
}
h1,h2,h3{text-align:center}
button{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  background:var(--accent);
  color:white;
  font-size:15px;
  margin-top:6px;
}
button.secondary{background:#2a2f3a}
button.danger{background:var(--danger)}
input,select{
  width:100%;
  padding:8px;
  margin-top:6px;
  background:#262a33;
  color:var(--text);
  border:1px solid #333;
  border-radius:6px;
}

/* =======================
   CARTES
======================= */
.card{
  background:var(--card);
  padding:15px;
  border-radius:12px;
  margin-top:15px;
}

/* =======================
   CALENDRIER
======================= */
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}
.weekday{
  text-align:center;
  font-weight:bold;
  font-size:12px;
}
.day{
  background:#262a33;
  border-radius:8px;
  padding:6px;
  text-align:center;
  cursor:pointer;
  min-height:60px;
}
.day.today{
  border:2px solid #ff9500;
}
.day.locked{
  opacity:.4;
  cursor:not-allowed;
}

/* =======================
   MODALES
======================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:3000;
}
.modal-content{
  background:var(--card);
  padding:20px;
  border-radius:12px;
  width:90%;
  max-width:420px;
}
#hoursChoices button{
  background:#2a2f3a;
}

/* =======================
   FLOU ‚Ç¨
======================= */
.blur{
  filter:blur(8px);
}

/* =======================
   BADGES
======================= */
.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:12px;
  font-size:12px;
}
.badge.ok{background:#1b5e20}
.badge.file{background:#283593}
</style>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

<h1>‚è±Ô∏è Heures suppl√©mentaires</h1>
<button onclick="openTutorial()"
style="position:fixed;top:15px;right:15px;z-index:4000;">
‚ùì Tutoriel
</button>
<div class="card">
  <label>Mois suivi</label>
  <input type="month" id="monthPicker">
  <label>Jour de cl√¥ture mensuelle</label>
  <input type="number" id="closingDay" min="1" max="31">
</div>

<div class="calendar card" id="calendar"></div>

<div class="card">
  <h3>R√©capitulatif</h3>
  <p>Report pr√©c√©dent : <b id="prevCarry">0.00</b> h</p>
  <p>Total mois : <b id="totalMonth">0.00</b> h</p>
  <p>Heures pay√©es : <input type="number" id="paidHours" step="0.25"></p>
  <p>Reliquat report√© : <b id="carryOver">0.00</b> h</p>

  <button id="lockBtn">üîì Mois modifiable</button>
</div>

<div class="card">
  <h3>üí∞ Valeur ‚Ç¨</h3>
  <div id="euroBox" class="blur">
    <label>Taux horaire (‚Ç¨)</label>
    <input type="number" id="rate">
    <label>Coef 25 %</label>
    <input type="number" id="coef25">
    <label>Coef 50 %</label>
    <input type="number" id="coef50">
    <label>Coef brut ‚Üí net</label>
    <input type="number" id="coefNet">
    <p><b id="euroResult">0.00 ‚Ç¨</b></p>
  </div>
  <input type="password" id="unlockCode" placeholder="Code (1234)">
  <button onclick="unlockEuro()">D√©verrouiller</button>
</div>
<button class="secondary" onclick="toggleChangeCode()">üîÅ Changer le code</button>

<div id="changeCodeBox" style="display:none;margin-top:10px">
  <input type="password" id="oldCode" placeholder="Ancien code">
  <input type="password" id="newCode" placeholder="Nouveau code (4 chiffres min)">
  <input type="password" id="confirmCode" placeholder="Confirmer le code">
  <button class="danger" onclick="changeCode()">Valider le nouveau code</button>
</div>
<div class="card">
  <span class="badge ok">üü¢ Sauvegarde locale auto</span>
  <span class="badge file">üíæ Dernier fichier : <span id="fileDate">‚Äî</span></span>
  <button onclick="exportJSON()">üíæ Sauvegarde dans un fichier</button>
  <input type="file" id="importFile" accept=".json" style="display:none">
<button class="secondary" onclick="document.getElementById('importFile').click()">
üì• Importer une sauvegarde
</button>
   <button onclick="exportMonthlyPDF()">üìÑ PDF mensuel d√©taill√©</button>
<button onclick="exportAnnualPDF()">üìï PDF annuel r√©capitulatif</button>
</div>

<!-- =======================
     POPUP HEURES
======================= -->
<div class="modal" id="hoursModal">
  <div class="modal-content">
    <h3>‚è±Ô∏è Ajouter des heures</h3>
    <div id="hoursChoices"></div>
    <label>Saisie manuelle</label>
    <input type="number" id="manualHours" step="0.25">
    <button onclick="confirmManual()">Valider</button>
    <button class="secondary" onclick="closeHours()">Annuler</button>
  </div>
</div>
<div class="modal" id="tutorialModal">
  <div class="modal-content" style="max-width:700px;max-height:80vh;overflow:auto;">
    <h2>üìò Tutoriel ‚Äì Suivi des heures suppl√©mentaires</h2>

    <h3>1Ô∏è‚É£ Principe g√©n√©ral</h3>
    <p>
      Cet outil permet de suivre les heures suppl√©mentaires dans le cadre
      d‚Äôune <b>paie mensuelle</b>, avec report automatique des reliquats.
    </p>

    <h3>2Ô∏è‚É£ Saisie des heures</h3>
    <ul>
      <li>Clique sur un jour</li>
      <li>Choisis +15 min, +30 min, +1h‚Ä¶ ou saisis manuellement</li>
      <li>Les heures sont enregistr√©es automatiquement</li>
    </ul>

    <h3>3Ô∏è‚É£ Cl√¥ture mensuelle</h3>
    <p>
      Le jour de cl√¥ture d√©finit la fin de la p√©riode de paie.
      Les heures apr√®s cette date sont automatiquement report√©es.
    </p>

    <h3>4Ô∏è‚É£ Zone ‚Ç¨</h3>
    <p>
      Les montants sont flout√©s par d√©faut et prot√©g√©s par code.
    </p>

    <button class="secondary" onclick="closeTutorial()">Fermer</button>
  </div>
</div>
<script>

/* =======================
   DONN√âES
======================= */
const STORAGE_PREFIX = "CA_HS_TRACKER_V1";
function kData(year){
  return `${STORAGE_PREFIX}_DATA_${year}`;
}
function kSettings(){
  return `${STORAGE_PREFIX}_SETTINGS`;
}
function kCode(){
  return `${STORAGE_PREFIX}_CODE_HASH`;
}
function kIndex(){
  return `${STORAGE_PREFIX}_INDEX`;
}
function kBackup(year, date){
  return `${STORAGE_PREFIX}_BACKUP_${year}_${date}`;
}
function getYearFromMonth(key){
  return key.split("-")[0];
}
let DATA = {};
let SETTINGS = JSON.parse(
  localStorage.getItem(kSettings()) || "{}"
);
let currentKey="", currentDay=null, unlocked=false;

/* =======================
   INIT
======================= */
const monthPicker = document.getElementById("monthPicker");
monthPicker.value = new Date().toISOString().slice(0,7);


/* =======================
   CALENDRIER
======================= */
function getPreviousCarry(key){
  const [y,m] = key.split("-").map(Number);
  let d = new Date(y, m-1, 1);

  while(true){
    d.setMonth(d.getMonth()-1);
    const k = d.toISOString().slice(0,7);
    if(DATA[k]) return DATA[k].carry || 0;
    if(d.getFullYear() < 2000) break;
  }
  return 0;
}
function loadMonth(){
  currentKey = monthPicker.value;
const year = getYearFromMonth(currentKey);
registerYear(year);
DATA = loadYearData(year);
if(!DATA[currentKey]){
  DATA[currentKey] = {
    days: {},
    paid: 0,
    carry: 0,
    closing: 31,
    locked: false
  };
}
closingDay.value = DATA[currentKey].closing || 31;
  renderCalendar();
  recalc();
  const prev = getPreviousCarry(currentKey);
document.getElementById("prevCarry").textContent = prev.toFixed(2);
updateLockUI();
paidHours.value = DATA[currentKey].paid || 0;
}
monthPicker.onchange=loadMonth;
const closingDay = document.getElementById("closingDay");
closingDay.onchange = ()=>{
  const [y,m] = currentKey.split("-").map(Number);
  const maxDay = new Date(y, m, 0).getDate();

  let val = parseInt(closingDay.value) || maxDay;
  val = Math.min(Math.max(1, val), maxDay);

  DATA[currentKey].closing = val;
  closingDay.value = val;

  save();
  recalc();
};
const lockBtn = document.getElementById("lockBtn");
const paidHours = document.getElementById("paidHours");

paidHours.oninput = ()=>{
  DATA[currentKey].paid = parseFloat(paidHours.value) || 0;
  save();
  recalc();
};

function renderCalendar(){
  const cal = document.getElementById("calendar");
  cal.innerHTML = "";
  const [y,m] = currentKey.split("-").map(Number);
  const days = new Date(y,m,0).getDate();

  for(let d=1; d<=days; d++){
    const div = document.createElement("div");
    div.className = "day";

    const isAfterClosing = d > DATA[currentKey].closing;
    const isMonthLocked = DATA[currentKey].locked;

    if(isAfterClosing || isMonthLocked){
      div.classList.add("locked");
    }

    const today = new Date();
    if(
      d === today.getDate() &&
      currentKey === today.toISOString().slice(0,7)
    ){
      div.classList.add("today");
    }

    const val = DATA[currentKey].days[d];
    div.innerHTML = `<b>${d}</b><br>${val ? val.toFixed(2)+" h" : ""}`;

    if(!isAfterClosing && !isMonthLocked){
      div.onclick = () => openHours(d);
    }

    cal.appendChild(div);
  }
}
/* =======================
   POPUP HEURES
======================= */
function openHours(d){
  currentDay=d;
  const c=document.getElementById("hoursChoices");
  c.innerHTML="";
  [0.25,0.5,0.75,1,1.25,1.5,2].forEach(v=>{
    const b=document.createElement("button");
    b.textContent="+"+v+" h";
    b.onclick=()=>applyHours(v);
    c.appendChild(b);
  });
  document.getElementById("hoursModal").style.display="flex";
}
function closeHours(){
  document.getElementById("hoursModal").style.display="none";
}
function applyHours(h){
  if(h <= 0) return;

  DATA[currentKey].days[currentDay] =
    (DATA[currentKey].days[currentDay] || 0) + h;

  save();
  recalc();
  closeHours();
}
function confirmManual(){
  const input = document.getElementById("manualHours");
  const h = parseFloat(input.value);
 if(isNaN(h) || h <= 0){
  alert("‚õî Valeur invalide");
  return;
}

  applyHours(h);
  input.value = ""; // ‚úÖ reset
}

/* =======================
   CALCUL
======================= */
function recalc(){
  const close = DATA[currentKey].closing || 31;
  const prevCarry = getPreviousCarry(currentKey);

  let inPeriod = 0;
  let outPeriod = 0;

  Object.entries(DATA[currentKey].days).forEach(([d,h])=>{
    if(parseInt(d) <= close) inPeriod += h;
    else outPeriod += h;
  });

  const paid = parseFloat(DATA[currentKey].paid) || 0;
  const carry = Math.max(0, inPeriod + prevCarry - paid) + outPeriod;

  DATA[currentKey].carry = carry;

  document.getElementById("prevCarry").textContent = prevCarry.toFixed(2);
  document.getElementById("totalMonth").textContent = inPeriod.toFixed(2);
  document.getElementById("carryOver").textContent = carry.toFixed(2);

    
  const payable = Math.max(0, inPeriod + prevCarry - paid);

if(unlocked){
  calcEuro(payable);
}
save();
}

/* =======================
   ‚Ç¨ CALCUL
======================= */
function calcEuro(h){
  if(!unlocked)return;
  const s = {
  rate: SETTINGS.rate || 20,
  coef25: SETTINGS.coef25 || 1.25,
  coef50: SETTINGS.coef50 || 1.5,
  coefNet: SETTINGS.coefNet || 0.93
};
  const h25=Math.min(h,8);
  const h50=Math.max(0,h-8);
  const brut=(h25*s.rate*s.coef25)+(h50*s.rate*s.coef50);
  const net=brut*s.coefNet;
  document.getElementById("euroResult").textContent=net.toFixed(2)+" ‚Ç¨";
}
async function sha256(str){
  const buf = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest("SHA-256", buf);
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2,"0"))
    .join("");
}

async function getSecureCode(){
  let h = localStorage.getItem(kCode());
  if(!h){
    h = await sha256("1234");
    localStorage.setItem(kCode(), h);
  }
  return h;
}
async function unlockEuro(){
  const input = document.getElementById("unlockCode").value;
  const inputHash = await sha256(input);

  if(input === "1234"){
  alert("‚ö†Ô∏è Pense √† changer le code par d√©faut");
}
    unlocked = true;
    document.getElementById("euroBox").classList.remove("blur");
    document.getElementById("unlockCode").value = "";
    recalc();
  } else {
    alert("‚ùå Code incorrect");
  }
}
function toggleChangeCode(){
  if(!unlocked){
    alert("üîí D√©verrouille d‚Äôabord la zone ‚Ç¨");
    return;
  }
  const box = document.getElementById("changeCodeBox");
  box.style.display = box.style.display === "none" ? "block" : "none";
}



/* =======================
   SAUVEGARDE
======================= */
function save(){
  const year = getYearFromMonth(currentKey);
  saveYearData(year, DATA);
  autoBackup(year);
}
async function changeCode(){
  const oldC = document.getElementById("oldCode").value;
  const newC = document.getElementById("newCode").value;
  const confC = document.getElementById("confirmCode").value;

  if(await sha256(oldC) !== await getSecureCode()){
    alert("‚ùå Ancien code incorrect");
    return;
  }

  if(newC.length < 4){
    alert("‚ö†Ô∏è 4 caract√®res minimum");
    return;
  }

  if(newC !== confC){
    alert("‚ùå Confirmation diff√©rente");
    return;
  }

  localStorage.setItem(kCode(), await sha256(newC));
  alert("‚úÖ Code modifi√©");

  document.getElementById("changeCodeBox").style.display="none";
}

lockBtn.onclick = ()=>{
  DATA[currentKey].locked = !DATA[currentKey].locked;
  save();
  updateLockUI();
};
function exportJSON(){
  const year = getYearFromMonth(currentKey);

const payload = {
  exportedAt: new Date().toISOString(),
  year,
  version: "1.2",
  DATA,
  SETTINGS
};

  const blob = new Blob(
    [JSON.stringify(payload,null,2)],
    {type:"application/json"}
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "heures_sup_backup_"+Date.now()+".json";
  a.click();

  document.getElementById("fileDate").textContent =
    new Date().toLocaleDateString();
}
function updateLockUI(){
  lockBtn.textContent = DATA[currentKey].locked
    ? "üîí Mois verrouill√©"
    : "üîì Mois modifiable";
}
/* =======================
   PARAMS ‚Ç¨
======================= */
["rate","coef25","coef50","coefNet"].forEach(id=>{
  document.getElementById(id).value=SETTINGS[id]|| (id==="coefNet"?0.93:(id==="rate"?20:1.25));
  document.getElementById(id).onchange=()=>{
    SETTINGS[id]=parseFloat(document.getElementById(id).value)||0;
    localStorage.setItem(
  kSettings(),
  JSON.stringify(SETTINGS)
);
    recalc();
  };
});
   function openTutorial(){
  document.getElementById("tutorialModal").style.display = "flex";
}
function closeTutorial(){
  document.getElementById("tutorialModal").style.display = "none";
}
function exportMonthlyPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.text("R√©capitulatif mensuel ‚Äì Heures suppl√©mentaires",10,15);
  pdf.text("Mois : "+currentKey,10,25);
  const total = document.getElementById("totalMonth").textContent;
pdf.text("Total p√©riode : "+total+" h",10,35);
  pdf.text("Report : "+carryOver.textContent+" h",10,45);
  pdf.save("heures_mensuelles_"+currentKey+".pdf");
}

function exportAnnualPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y=15;
  pdf.text("Bilan annuel ‚Äì Heures suppl√©mentaires",10,y); y+=10;

  Object.keys(DATA).sort().forEach(k=>{
    pdf.text(k+" ‚Üí "+(DATA[k].carry||0)+" h",10,y);
    y+=6;
    if(y>270){pdf.addPage();y=15;}
  });

  pdf.save("heures_annuelles.pdf");
}

loadMonth();

function autoBackup(year){
  const stamp = new Date().toISOString().slice(0,10);
  localStorage.setItem(
    kBackup(year, stamp),
    JSON.stringify({DATA, SETTINGS})
  );
}
function registerYear(year){
  let index = JSON.parse(localStorage.getItem(kIndex()) || "[]");
  if(!index.includes(year)){
    index.push(year);
    index.sort();
    localStorage.setItem(kIndex(), JSON.stringify(index));
  }
}

function loadYearData(year){
  return JSON.parse(
    localStorage.getItem(kData(year)) || "{}"
  );
}

function saveYearData(year, data){
  localStorage.setItem(
    kData(year),
    JSON.stringify(data)
  );
}
function importJSONFile(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();

  reader.onload = () => {
    let payload;

    try{
      payload = JSON.parse(reader.result);
    } catch(err){
      alert("‚ùå Fichier invalide");
      return;
    }

    // üîí V√©rifications minimales
    if(!payload.DATA || !payload.year){
      alert("‚ùå Format non reconnu");
      return;
    }

    const year = payload.year;// ‚úÖ Appliquer les param√®tres ‚Ç¨
if(payload.SETTINGS){
  SETTINGS = payload.SETTINGS;
  localStorage.setItem(
    kSettings(),
    JSON.stringify(SETTINGS)
  );
}
    registerYear(year);

    const existing = loadYearData(year);

    let added = 0;
    let skipped = 0;

    Object.keys(payload.DATA).forEach(monthKey=>{
      if(!existing[monthKey]){
        existing[monthKey] = payload.DATA[monthKey];
        added++;
      } else {
        skipped++;
      }
    });

    saveYearData(year, existing);

    alert(
      `‚úÖ Import termin√©\n\n` +
      `Ann√©e : ${year}\n` +
      `Mois ajout√©s : ${added}\n` +
      `Mois ignor√©s : ${skipped}`
    );

    // Recharge si on est sur la m√™me ann√©e
    if(getYearFromMonth(currentKey) === String(year)){
      DATA = loadYearData(year);
      loadMonth();
    }
  };

  reader.readAsText(file);
  e.target.value = ""; // reset input
}
document.getElementById("importFile").addEventListener("change", importJSONFile);
</script>
<div class="card" style="font-size:13px;color:#aaa">
  <h3>üìò Notice utilisateur</h3>

  <p>
    Cet outil est destin√© au suivi personnel des heures suppl√©mentaires
    dans le cadre d‚Äôune r√©mun√©ration mensuelle.
  </p>

  <p>
    Les calculs sont indicatifs et reposent sur les principes g√©n√©raux :
  </p>

  <ul>
    <li>Code du travail</li>
    <li>Convention collective du commerce de gros (IDCC 573)</li>
  </ul>

  <p>
    ‚ö†Ô∏è En cas de litige, seuls les bulletins de paie et documents
    officiels de l‚Äôemployeur font foi.
  </p>
</div>
<footer style="margin-top:30px;text-align:center;font-size:12px;color:#777">
  ¬© Tous droits r√©serv√©s ‚Äì C. Anthony<br>
  Outil indicatif ‚Äì ne constitue pas un bulletin de paie
</footer>

</body>
</html>
