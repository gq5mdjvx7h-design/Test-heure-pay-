<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Heures supplÃ©mentaires â€“ Paie mensuelle</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* =========================
   THÃˆME SOMBRE PRO
========================= */
:root{
  --bg:#0f1115;
  --card:#1c1f26;
  --text:#e6e6e6;
  --muted:#9aa0a6;
  --accent:#4f8cff;
  --danger:#c0392b;
  --success:#2ecc71;
  --warning:#f39c12;
}

body{
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;
  margin:0;
  padding:15px;
}

h1,h2,h3{text-align:center}

.card{
  background:var(--card);
  padding:15px;
  border-radius:12px;
  max-width:1000px;
  margin:15px auto;
}

button,input{
  background:#262a33;
  color:var(--text);
  border:1px solid #333;
  border-radius:8px;
  padding:8px;
}

button{background:var(--accent);border:none;cursor:pointer}
button.secondary{background:#2a2f3a}
button.danger{background:var(--danger)}

.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
  margin-right:8px;
}
.badge.success{background:#1e4620;color:#7dff9e}
.badge.info{background:#1e3a5f;color:#9fd0ff}

.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:6px;
}
.weekday{text-align:center;font-weight:bold;font-size:12px;color:var(--muted)}

.day{
  background:#262a33;
  border-radius:8px;
  padding:6px;
  text-align:center;
  min-height:75px;
  cursor:pointer;
}
.day.today{outline:3px solid var(--warning)}
.day.out{opacity:.35}
.day.locked{cursor:not-allowed;opacity:.45}
.day .h{font-weight:bold;margin-top:4px}

.blur{filter:blur(8px)}

.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:5000;
}
.modal-content{
  background:var(--card);
  padding:20px;
  border-radius:12px;
  max-width:650px;
  width:90%;
  max-height:85vh;
  overflow:auto;
}

.footer{
  max-width:1000px;
  margin:30px auto;
  font-size:12px;
  color:#888;
  text-align:center;
}
.footer a{color:#aaa;margin:0 6px;text-decoration:none}
</style>
</head>

<body>

<h1>ğŸ§¾ Heures supplÃ©mentaires â€“ Paie mensuelle</h1>

<!-- ================= PÃ‰RIODE ================= -->
<div class="card">
  <h2>ğŸ“… PÃ©riode de paie</h2>

  <label>Mois affichÃ©</label>
  <input type="month" id="monthPicker">

  <label>Jour de clÃ´ture comptable</label>
  <input type="number" id="closingDay" min="1" max="31">

  <p id="periodInfo"></p>

  <button id="lockBtn" onclick="toggleLock()">ğŸ”“ PÃ©riode dÃ©verrouillÃ©e</button>
</div>

<!-- ================= CALENDRIER ================= -->
<div class="card">
  <div class="calendar" id="calendar"></div>

  <br>
  <span class="badge success" id="autoSave">ğŸŸ¢ Sauvegarde automatique locale</span>
  <span class="badge info" id="fileSave">ğŸ’¾ Aucune sauvegarde fichier</span>

  <br><br>
  <button onclick="exportJSON()">ğŸ’¾ Sauvegarde dans un fichier</button>
  <button onclick="exportPDFMonth()">ğŸ“„ PDF pÃ©riode</button>
  <button onclick="exportPDFDetailed()">ğŸ“„ PDF dÃ©taillÃ©</button>
  <button onclick="exportPDFYear()">ğŸ“˜ PDF annuel</button>
</div>

<!-- ================= TOTAUX ================= -->
<div class="card">
  <h2>ğŸ“Š Totaux pÃ©riode</h2>

  <p>Total heures supplÃ©mentaires : <b id="totalH">0.00 h</b></p>

  <p>Heures payÃ©es ce mois :
    <input type="number" id="paid" step="0.25">
  </p>

  <p>Reliquat reportÃ© : <b id="carry">0.00 h</b></p>

  <div id="euroZone" class="blur">
    <h3>ğŸ’¶ Valeur estimÃ©e</h3>
    <p id="euros">0 â‚¬</p>
  </div>

  <input type="password" id="codeInput" placeholder="Code pour afficher les montants">
  <button onclick="unlockEuros()">DÃ©verrouiller</button>
</div>

<!-- ================= CONFIG ================= -->
<div class="card">
  <h2>ğŸ”§ Configuration</h2>
  <button class="secondary" onclick="importJSON()">â™»ï¸ Restaurer depuis un fichier</button>
</div>

<!-- ================= FOOTER ================= -->
<div class="footer">
  Â© Tous droits rÃ©servÃ©s â€“ C. Anthony Â·
  <a href="#" onclick="openModal('tuto')">â“ Tutoriel</a> Â·
  <a href="#" onclick="openModal('notice')">ğŸ“˜ Notice dâ€™utilisation</a> Â·
  <a href="#" onclick="openModal('legal')">â„¹ï¸ Informations lÃ©gales</a>
</div>

<!-- ================= MODAL ================= -->
<div class="modal" id="modal">
  <div class="modal-content" id="modalContent"></div>
</div>

<script>
/* ================= DONNÃ‰ES ================= */
const PREFIX="PAIE_MENSUELLE_V42_";
const today=new Date();
let currentMonth="";
let data={};

const mp=document.getElementById("monthPicker");
mp.value=today.toISOString().slice(0,7);
mp.onchange=loadMonth;

paid.oninput=()=>{data.paid=+paid.value||0;save();calc();}
closingDay.onchange=()=>{data.closing=+closingDay.value;save();build();calc();}

function key(m){return PREFIX+m}

/* ================= LOAD ================= */
function loadMonth(){
  currentMonth=mp.value;
  data=JSON.parse(localStorage.getItem(key(currentMonth)))||{
    days:{},paid:0,carry:0,closing:31,locked:false
  };
  paid.value=data.paid;
  closingDay.value=data.closing;
  updateLock();
  build();
  calc();
}
loadMonth();

/* ================= CALENDRIER ================= */
function build(){
  calendar.innerHTML="";
  ["L","M","M","J","V","S","D"].forEach(d=>{
    let w=document.createElement("div");
    w.className="weekday";w.textContent=d;
    calendar.appendChild(w);
  });

  const [y,m]=currentMonth.split("-").map(Number);
  const days=new Date(y,m,0).getDate();
  const first=(new Date(y,m-1,1).getDay()+6)%7;
  for(let i=0;i<first;i++)calendar.appendChild(document.createElement("div"));

  const start=new Date(y,m-1,data.closing+1);start.setMonth(start.getMonth()-1);
  const end=new Date(y,m-1,data.closing);

  for(let d=1;d<=days;d++){
    const div=document.createElement("div");
    const date=new Date(y,m-1,d);
    const h=data.days[d]||0;

    div.className="day"+(date<start||date>end?" out":"");
    if(data.locked)div.classList.add("locked");
    if(date.toDateString()===today.toDateString())div.classList.add("today");

    div.innerHTML=`<div>${d}</div><div class="h">${h?h.toFixed(2)+"h":""}</div>`;

    div.onclick=()=>{
      if(data.locked){
        alert("ğŸ”’ PÃ©riode verrouillÃ©e (lecture seule)");
        return;
      }
      const options=[0.25,0.5,0.75,1,1.25,1.5,2];
      const v=prompt(
        "Heures supplÃ©mentaires (15 min = 0.25)\nExemples : 0.25 / 0.5 / 1 / 2",
        h||""
      );
      const val=parseFloat(v);
      if(!isNaN(val)){
        data.days[d]=val;
        save();build();calc();
      }
    };

    calendar.appendChild(div);
  }

  periodInfo.innerHTML=`PÃ©riode comptable : ${start.toLocaleDateString()} â†’ ${end.toLocaleDateString()}`;
}

/* ================= REPORT EN CASCADE ================= */
function getPrevCarry(){
  let d=new Date(currentMonth+"-01");
  while(true){
    d.setMonth(d.getMonth()-1);
    const k=d.toISOString().slice(0,7);
    const o=JSON.parse(localStorage.getItem(key(k)));
    if(o) return o.carry||0;
    if(d.getFullYear()<2000) break;
  }
  return 0;
}

/* ================= CALCUL ================= */
function calc(){
  let total=Object.values(data.days).reduce((a,b)=>a+b,0);

  let h25=Math.min(total,8);
  let h50=Math.max(0,total-8);

  const prev=getPrevCarry();
  const brut=h25*1.25+h50*1.5+prev;
  const net=brut-(data.paid||0);

  data.carry=net;

  totalH.textContent=total.toFixed(2)+" h";
  carry.textContent=net.toFixed(2)+" h";
  euros.textContent=(net*20).toFixed(2)+" â‚¬";

  save();
}

/* ================= LOCK ================= */
function toggleLock(){
  if(data.locked && !confirm("DÃ©verrouiller la pÃ©riode ?\nToute modification recalculera les mois suivants.")) return;
  data.locked=!data.locked;
  save();updateLock();
}
function updateLock(){
  lockBtn.textContent=data.locked?"ğŸ”’ PÃ©riode verrouillÃ©e":"ğŸ”“ PÃ©riode dÃ©verrouillÃ©e";
  lockBtn.style.background=data.locked?"var(--danger)":"var(--accent)";
}

/* ================= SAVE ================= */
function save(){
  localStorage.setItem(key(currentMonth),JSON.stringify(data));
  autoSave.textContent="ğŸŸ¢ Sauvegarde automatique locale â€“ "+new Date().toLocaleTimeString();
}

/* ================= EUROS ================= */
function unlockEuros(){
  if(codeInput.value==="1234") euroZone.classList.remove("blur");
  else alert("Code incorrect");
}

/* ================= PDF ================= */
function exportPDFMonth(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("RÃ©capitulatif pÃ©riode de paie",10,15);
  pdf.text("Mois : "+currentMonth,10,25);
  pdf.text("Total heures sup : "+totalH.textContent,10,35);
  pdf.text("Reliquat : "+carry.textContent,10,45);
  pdf.text("Document informatif â€“ ne constitue pas un bulletin de paie.",10,80);
  pdf.save("periode_"+currentMonth+".pdf");
}

function exportPDFDetailed(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();

  const [y,m]=currentMonth.split("-").map(Number);
  const start=new Date(y,m-1,data.closing+1);start.setMonth(start.getMonth()-1);
  const end=new Date(y,m-1,data.closing);

  let yPos=15;
  pdf.setFontSize(14);
  pdf.text("Heures supplÃ©mentaires â€“ DÃ©tail mensuel",10,yPos);
  yPos+=8;

  pdf.setFontSize(10);
  pdf.text(`PÃ©riode : ${start.toLocaleDateString()} â†’ ${end.toLocaleDateString()}`,10,yPos);
  yPos+=6;
  pdf.text(`Statut : ${data.locked?"VerrouillÃ©e":"Modifiable"}`,10,yPos);
  yPos+=8;

  pdf.line(10,yPos,200,yPos);yPos+=6;

  Object.keys(data.days).sort((a,b)=>a-b).forEach(d=>{
    const date=new Date(y,m-1,d);
    if(date<start||date>end) return;
    const h=data.days[d];
    if(!h) return;
    pdf.text(`${date.toLocaleDateString()} : ${h.toFixed(2)} h`,12,yPos);
    yPos+=4;
    if(yPos>270){pdf.addPage();yPos=15;}
  });

  pdf.addPage();
  yPos=15;

  let total=Object.values(data.days).reduce((a,b)=>a+b,0);
  let h25=Math.min(total,8);
  let h50=Math.max(0,total-8);
  const prev=getPrevCarry();
  const brut=h25*1.25+h50*1.5+prev;
  const net=brut-(data.paid||0);

  pdf.text("RÃ©capitulatif",10,yPos);yPos+=8;
  pdf.text(`Heures totales : ${total.toFixed(2)} h`,10,yPos);yPos+=5;
  pdf.text(`25 % : ${h25.toFixed(2)} h`,10,yPos);yPos+=5;
  pdf.text(`50 % : ${h50.toFixed(2)} h`,10,yPos);yPos+=5;
  pdf.text(`Report prÃ©cÃ©dent : ${prev.toFixed(2)} h`,10,yPos);yPos+=5;
  pdf.text(`Reliquat final : ${net.toFixed(2)} h`,10,yPos);yPos+=8;
  pdf.text(`Valeur estimÃ©e : ${(net*20).toFixed(2)} â‚¬`,10,yPos);

  yPos+=12;
  pdf.setFontSize(8);
  pdf.text(
    "Document informatif â€“ calcul basÃ© sur le Code du travail\n" +
    "et la convention collective du commerce de gros.\n" +
    "Ne constitue pas un bulletin de paie.",
    10,yPos
  );

  pdf.save(`detail_heures_${currentMonth}.pdf`);
}

function exportPDFYear(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("RÃ©capitulatif annuel â€“ Heures supplÃ©mentaires",10,15);
  pdf.text("Document informatif.",10,30);
  pdf.save("annuel_"+new Date().getFullYear()+".pdf");
}

/* ================= JSON ================= */
function exportJSON(){
  const blob=new Blob([JSON.stringify(localStorage,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="sauvegarde_heures_sup.json";
  a.click();
  fileSave.textContent="ğŸ’¾ DerniÃ¨re sauvegarde fichier : "+new Date().toLocaleDateString();
}
function importJSON(){
  const i=document.createElement("input");
  i.type="file";i.accept=".json";
  i.onchange=e=>{
    const r=new FileReader();
    r.onload=()=>{
      const o=JSON.parse(r.result);
      Object.keys(o).forEach(k=>localStorage.setItem(k,o[k]));
      location.reload();
    }
    r.readAsText(e.target.files[0]);
  };
  i.click();
}

/* ================= MODALS ================= */
function openModal(type){
  let html="";
  if(type==="tuto"){
    html="<h3>ğŸ“ Tutoriel</h3><ol><li>Choisir le mois</li><li>DÃ©finir la clÃ´ture</li><li>Saisir les heures</li><li>VÃ©rifier les totaux</li><li>Verrouiller</li><li>Sauvegarder</li></ol>";
  }
  if(type==="notice"){
    html="<h3>ğŸ“˜ Notice dâ€™utilisation</h3><p>Outil de suivi des heures supplÃ©mentaires dans le cadre dâ€™une paie mensuelle avec report automatique.</p>";
  }
  if(type==="legal"){
    html="<h3>â„¹ï¸ Informations lÃ©gales</h3><p>Calcul conforme au Code du travail et Ã  la convention collective du commerce de gros.</p><p>Document informatif.</p>";
  }
  modalContent.innerHTML=html+"<br><button onclick='closeModal()'>Fermer</button>";
  modal.style.display="flex";
}
function closeModal(){modal.style.display="none"}
</script>

</body>
</html>
